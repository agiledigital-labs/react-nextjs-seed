# Modified from base yml generated by toolform (0.0.1-SNAPSHOT)
apiVersion: v1
kind: Template
parameters:
- name: RELEASE_TAG
  description: Release tag to pull docker images from
- name: ENVIRONMENT
  description: Environment being deployed
objects:
- apiVersion: v1
  kind: ConfigMap
  metadata:
    name: deployment-details
  data:
    ENVIRONMENT: ${ENVIRONMENT}
    RELEASE: ${RELEASE_TAG}
    API_EXTERNAL_URL: https://www.example.com/api/v1                            //ToDo #@Change-this
    CLIENT_EXTERNAL_URL: https://project.example.com                      //ToDo #@Change-this
    CLIENT_EXTERNAL_HOST: staging.CompanyName.co    //ToDo #@Change-this
- 
  apiVersion: v1
  kind: Service
  metadata:
    annotations:
      source.path: "client"
      project.artefact: "true"
    name: client
  spec:
    type: ClusterIP
    selector:
      component: client
    ports:
    -
      name: "port-3000"
      port: 3000
      targetPort: 3000
      protocol: TCP
- 
  apiVersion: v1
  kind: DeploymentConfig
  metadata:
    annotations:
      source.path: "client"
      project.artefact: "true"
    name: client
  spec:
    replicas: 1
    triggers:
      - type: ConfigChange
      - type: ImageChange
        imageChangeParams:
          automatic: true
          containerNames:
          - client
          from:
            kind: ImageStreamTag
            name: #@Change-this-client-image:${RELEASE_TAG}
    template:
      metadata:
        labels:
          component: client
      spec:
        containers:
        -
          image: #@Change-this-client-image:${RELEASE_TAG}
          name: client
          imagePullPolicy: Always
          envFrom:
          - configMapRef:
              name: deployment-details
          - configMapRef:
              name: config-overrides
          ports:
            - containerPort: 3000
          readinessProbe:
            httpGet:
              path: /
              port: 3000
            initialDelaySeconds: 15
            timeoutSeconds: 1
- 
  apiVersion: v1
  kind: Route
  metadata:
    name: client-route
    annotations:
      kubernetes.io/tls-acme: 'true'
  spec:
    host: #@Change-this.staging.example.co
    to:
      kind: Service
      name: client
    tls:
      insecureEdgeTerminationPolicy: Redirect
